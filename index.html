<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tetris!</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #eee;
            font-family: sans-serif;
            overflow: hidden;
        }
        .finger-indicator {
            position: absolute;
            z-index: 4;
            border: 2px solid #4a4;
            background-color: rgba(0,50,0,0.5);
            padding: 4px;
        }
        .finger-indicator.control {
            background-color: rgba(50,0,0,0.5);
            border: 2px solid #a44;
        }
        #indicatorcontainer {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }
        #board_canvas, #animated_canvas, #shadow_canvas {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 1;
        }
        #animated_canvas { z-index: 3; }
        #shadow_canvas { z-index: 2; }
        #score-container {
            position: fixed;
            top: 10px;
            left: 140px;
            font-family: sans-serif;
            font-size: 30px;
            color: black;
            padding: 10px 20px;
            border-radius: 10px;
        }
        #score-value {
            font-weight: bold;
            color: #ffcc00;
            font-size: 40px;
        }
        .score-animation {
            position: absolute;
            color: #000;
            font-weight: bold;
            font-size: 20px;
            opacity: 1;
            transition: all 0.8s ease-out;
            pointer-events: none;
            z-index: 10;
        }
        #level {
            font-size: 20px;
            color: black;
            margin-top: 5px;
        }
        #instructions h1 {
            margin-top: 0;
            color: #333;
        }
        #instr {
            display: block;
        }
        #scoring-info {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
        }
        #scoring-info h3 {
            margin-top: 0;
            color: #333;
        }
        .scoring-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .points {
            font-weight: bold;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div id="indicatorcontainer"></div>
    <canvas id="board_canvas" width="120" height="250">Your browser does not support HTML5 Canvas.</canvas>
    <canvas id="animated_canvas" width="120" height="250"></canvas>
    <canvas id="shadow_canvas" width="120" height="250"></canvas>
    
    <div id="score-container">
        <div id="score-value">0</div>
        <div id="level">Level: 1</div>
    </div>

    <div id="instructions">
        <div id="instr">
        </div>
    </div>

    <script>
    // Combined JavaScript from tetris2.js and tetris3.js
    
    // Text rendering functions from tetris2.js
    function check_strokeTextCapability() {
        if(document.namespaces['v']==null) {
            var e=["shape","shapetype","group","background","path","formulas","handles","fill","stroke","shadow","textbox","textpath","imagedata","line","polyline","curve","roundrect","oval","rect","arc","image"],s=document.createStyleSheet(); 
            for(var i=0; i<e.length; i++) {s.addRule("v\\:"+e[i],"behavior: url(#default#VML);");} document.namespaces.add("v","urn:schemas-microsoft-com:vml");
        } 
        if(typeof get_strokeText == 'function' && document.namespaces['v'] != null) {return true;}else {return false;}
    }
    
    function get_boundingBox(x,y,baseline,lineheight,linewidth,weight,color,opacity,rotation) {
        rotation=typeof(rotation)!='undefined'?rotation:0; color=typeof(color)!='undefined'?color:'#000000'; opacity=typeof(opacity)!='undefined'?opacity:1; id=typeof(id)!='undefined'?'id="'+id+'"':''; var w=parseInt(linewidth), b=parseInt(baseline), h=parseInt(lineheight);
        return '<v:shape '+id+' filled="f" stroked="t" coordorigin="0,0" coordsize="'+w+','+h+'" path="m 0,'+b+' l 0,0,'+w+',0,'+w+','+b+',0,'+b+',0,'+h+','+w+','+h+','+w+','+b+' e" style="rotation:'+rotation+';position:absolute;margin:0px;top:'+Math.round(y)+'px;left:'+Math.round(x)+'px;width:'+w+'px;height:'+h+'px;"><v:stroke color="'+color+'" opacity="'+opacity+'" weight="'+weight+'" /></v:shape>';    
    }
    
    function get_strokeText(string,x,y,size,weight,width,space,font,color,opacity,rotation,id) {
        function qC(cX,cY,CPx,CPy,aX,aY) {var t = new Array(6); t[0]=cX+2.0/3.0*(CPx-cX); t[1]=cY+2.0/3.0*(CPy-cY); t[2]=t[0]+(aX-cX)/3.0; t[3]=t[1]+(aY-cY)/3.0; t[4]=aX; t[5]=aY; return t;}
        size=typeof(size)!='undefined'?size:12; weight=typeof(weight)!='undefined'?weight:100; width=typeof(width)!='undefined'?width:100; space=typeof(space)!='undefined'?space:100;
        font=typeof(font)!='undefined'?font:"sans-serif"; string=typeof(string)!='undefined'?string:' '; var xx=typeof(x)!='undefined'?x:0; var yy=typeof(y)!='undefined'?y:0;
        rotation=typeof(rotation)!='undefined'?rotation:0; color=typeof(color)!='undefined'?color:'#000000'; opacity=typeof(opacity)!='undefined'?opacity:1; id=typeof(id)!='undefined'?'id="'+id+'"':'';
        var i=0,j=0,f=10,path="",a,b,z,k,c,p,o,len=string.length,mag=size/25.0,fac=Math.max(Math.min(weight,400),1)/40, faw=Math.max(Math.min(width,400),10)/100;
        var spc=Math.max(Math.min(space,1000),10)/100,mx=((mag*16*faw)*spc)-(mag*16*faw),lw=(fac*mag);x=0;y=size;
        var ww=Math.round(get_textWidth(string,size,width,space,font)), hh=Math.round(get_textHeight(size));
        var out='<v:shape '+id+' filled="f" stroked="t" coordorigin="0,0" coordsize="'+parseInt(ww*f)+','+parseInt(hh*f)+'"';
        for(i=0; i<len; i++) { c=strokeFont[font][string.charAt(i)]; if(!c) {continue;} o=0; 
            for(j=0; j<c.n; j++) {
                if(typeof(c.d[o])!="string") {o++; continue;} p=c.d[o]; o++; a=c.d[o];
                if(p=="m") {path+=' m '+parseInt((x+a[0]*mag*faw)*f)+','+parseInt((y-a[1]*mag)*f); o++;}else
                if(p=="q") {z=c.d[o-2]; o++; b=c.d[o]; k=qC(z[0],z[1],a[0],a[1],b[0],b[1]); path+=' c '+parseInt((x+k[0]*mag*faw)*f)+','+parseInt((y-k[1]*mag)*f)+','+parseInt((x+k[2]*mag*faw)*f)+','+parseInt((y-k[3]*mag)*f)+','+parseInt((x+k[4]*mag*faw)*f)+','+parseInt((y-k[5]*mag)*f); o++;}else 
                if(p=="b") {o++; b=c.d[o]; o++; z=c.d[o]; path+=' c '+parseInt((x+a[0]*mag*faw)*f)+','+parseInt((y-a[1]*mag)*f)+','+parseInt((x+a[0]*mag*faw)*f)+','+parseInt((y-a[1]*mag)*f)+','+parseInt((x+z[0]*mag*faw)*f)+','+parseInt((y-z[1]*mag)*f); o++;}else
                if(p=="l") {path+=' l '+parseInt((x+a[0]*mag*faw)*f)+','+parseInt((y-a[1]*mag)*f); o++; while(typeof(c.d[o])!="string" && o<c.d.length) {a=c.d[o]; path+=' l '+parseInt((x+a[0]*mag*faw)*f)+','+parseInt((y-a[1]*mag)*f); o++;}}
            } x+=((c.w*faw)*mag)+mx;
        } out+=' path="'+path+' e" style="rotation:'+rotation+';position:absolute;margin:0px;top:'+Math.round(yy)+'px;left:'+Math.round(xx)+'px;width:'+ww+'px;height:'+hh+'px;"><v:stroke color="'+color+'" opacity="'+opacity+'" weight="'+lw+'" miterlimit="0" endcap="round" joinstyle="round" /></v:shape>';    
        return out;
    }
    
    function get_baseLine(size) {return size;} 
    function get_textHeight(size) {size=typeof(size)!='undefined'?size:12; return 32*(size/25);} 
    function get_textWidth(string,size,width,space,font) {
        size=typeof(size)!='undefined'?size:12; width=typeof(width)!='undefined'?width:100; space=typeof(space)!='undefined'?space:100; string=typeof(string)!='undefined'?string:' ';
        font=typeof(font)!='undefined'?font:"sans-serif"; var total=0,len=string.length,mg=size/25.0,fw=Math.max(Math.min(width,400),10)/100,sp=Math.max(Math.min(space,1000),10)/100,m=((mg*16*fw)*sp)-(mg*16*fw);     
        for(var i=0; i<len; i++) {var c=strokeFont[font][string.charAt(i)]; if(c) total += ((c.w*fw)*mg)+m;}return total-(m);
    }
    
    function get_widthText(string,width,size,fontwidth,space,font) {
        size=typeof(size)!='undefined'?size:12; fontwidth=typeof(fontwidth)!='undefined'?fontwidth:100; space=typeof(space)!='undefined'?space:100; string=typeof(string)!='undefined'?string:' '; width=typeof(width)!='undefined'?width:100;
        font=typeof(font)!='undefined'?font:"sans-serif"; var cur=0,total=0,len=string.length,mg=size/25.0,fw=Math.max(Math.min(fontwidth,400),10)/100,sp=Math.max(Math.min(space,1000),10)/100,m=((mg*16*fw)*sp)-(mg*16*fw);     
        for(var i=0; i<len; i++) {var c=strokeFont[font][string.charAt(i)]; if(c) {cur = ((c.w*fw)*mg)+m; if((total+cur-(m)) <= width) {total += cur;}else {break; }}else {break; }} return string.substring(0,i); 
    }
    
    function draw_boundingBox(ctx,x,y,baseline,lineheight,linewidth) {ctx.strokeRect(x,y+baseline,linewidth,lineheight-baseline); ctx.strokeRect(x,y,linewidth,baseline);}
    
    function do_drawText(string,x,y,size,weight,width,space,font) {
        size=typeof(size)!='undefined'?size:12; weight=typeof(weight)!='undefined'?weight:100; width=typeof(width)!='undefined'?width:100; space=typeof(space)!='undefined'?space:100;
        font=typeof(font)!='undefined'?font:"sans-serif"; x=typeof(x)!='undefined'?x:0; y=typeof(y)!='undefined'?y+size:0+size; string=typeof(string)!='undefined'?string:' ';
        var i=0,j=0,a,b,z,c,p,o,len=string.length,mag=size/25.0,fac=Math.max(Math.min(weight,400),1)/40, faw=Math.max(Math.min(width,400),10)/100;
        var spc=Math.max(Math.min(space,1000),10)/100,mx=((mag*16*faw)*spc)-(mag*16*faw),lw=this.lineWidth, ml=this.miterLimit, lj=this.lineJoin, lc=this.lineCap;
        this.lineWidth=(fac*mag); this.miterLimit=0; this.lineJoin="round"; this.lineCap="round";
        for(i=0; i<len; i++) { c=strokeFont[font][string.charAt(i)]; if(!c) {continue;} o=0; this.beginPath(); 
            for(j=0; j<c.n; j++) {
                if(typeof(c.d[o])!="string") {o++; continue;} p=c.d[o]; o++; a=c.d[o];
                if(p=="m") {this.moveTo(x+a[0]*mag*faw, y-a[1]*mag); o++;}else
                if(p=="q") {o++; b=c.d[o]; this.quadraticCurveTo(x+a[0]*mag*faw, y-a[1]*mag, x+b[0]*mag*faw, y-b[1]*mag); o++;}else 
                if(p=="b") {o++; b=c.d[o]; o++; z=c.d[o]; this.bezierCurveTo(x+a[0]*mag*faw, y-a[1]*mag, x+b[0]*mag*faw, y-b[1]*mag, x+z[0]*mag*faw, y-z[1]*mag); o++;}else 
                if(p=="l") {this.lineTo(x+a[0]*mag*faw, y-a[1]*mag); o++; while(typeof(c.d[o])!="string" && o<c.d.length) {a=c.d[o]; this.lineTo(x+a[0]*mag*faw, y-a[1]*mag); o++;}}
            } this.stroke(); x+=((c.w*faw)*mag)+mx;
        } this.lineWidth=lw; this.miterLimit=ml; this.lineJoin=lj; this.lineCap=lc;
    }
    
    function set_textRenderContext(ctx) {if(typeof CanvasRenderingContext2D == 'undefined') {ctx.strokeText=do_drawText;}}
    function check_textRenderContext(ctx) {if(typeof ctx.strokeText == 'function') {return true;}else {return false;}}
    if(typeof CanvasRenderingContext2D != 'undefined') {CanvasRenderingContext2D.prototype.strokeText=do_drawText; }
    
    var strokeFont = new Array();
    strokeFont["sans-serif"] = {
        ' ': {w:16,n:1,d:[]},
        '!': {w:10,n:4,d:['m',[5,21],'l',[5,7],'m',[5,2],'l',[4,1],[5,0],[6,1],[5,2]]},
        '"': {w:14,n:4,d:['m',[4,21],'l',[4,14],'m',[10,21],'l',[10,14]]},
        '#': {w:21,n:8,d:['m',[11,25],'l',[4,-7],'m',[17,25],'l',[10,-7],'m',[4,12],'l',[18,12],'m',[3,6],'l',[17,6]]},
        '$': {w:20,n:12,d:['m',[16,18],'q',[15,21],[10,21],'q',[5,21],[4,17],'q',[3,12],[7,11],'l',[13,10],'q',[18,9],[17,4],'q',[16,0],[10,0],'q',[4,0],[3,4],'m',[8,25],'l',[6,-4],'m',[14,25],'l',[12,-4]]},
        '%': {w:24,n:12,d:['m',[21,21],'l',[3,0],'m',[7,21],'q',[3,21],[3,17],'q',[3,13],[7,13],'q',[11,13],[11,17],'q',[11,21],[7,21],'m',[17,8],'q',[13,8],[13,4],'q',[13,0],[17,0],'q',[21,0],[21,4],'q',[21,8],[17,8]]},
        '&': {w:26,n:14,d:['m',[23,12],'q',[23,14],[22,14],'q',[20,14],[19,11],'l',[17,6],'q',[15,0],[9,0],'q',[3,0],[3,5],'q',[3,8],[7,10],'l',[12,13],'q',[14,15],[14,17],'q',[14,21],[11,21],'q',[8,21],[8,17],'q',[8,14],[12,8],'q',[17,0],[21,0],'q',[23,0],[23,2]]},
        '\'': {w:10,n:2,d:['m',[5,19],'l',[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},
        '(': {w:14,n:3,d:['m',[11,25],'q',[4,19],[4,9],'q',[4,-1],[11,-7]]},
        ')': {w:14,n:3,d:['m',[3,25],'q',[10,19],[10,9],'q',[10,-1],[3,-7]]},
        '*': {w:16,n:6,d:['m',[8,21],'l',[8,9],'m',[3,18],'l',[13,12],'m',[13,18],'l',[3,12]]},
        '+': {w:26,n:4,d:['m',[13,18],'l',[13,0],'m',[4,9],'l',[22,9]]},
        ',': {w:10,n:2,d:['m',[6,1],'l',[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},
        '-': {w:26,n:2,d:['m',[4,9],'l',[22,9]]},
        '.': {w:10,n:2,d:['m',[5,2],'l',[4,1],[5,0],[6,1],[5,2]]},
        '/': {w:22,n:2,d:['m',[20,25],'l',[2,-7]]},
        '0': {w:20,n:7,d:['m',[10,21],'q',[3,21],[3,12],'l',[3,9],'q',[3,0],[10,0],'q',[17,0],[17,9],'l',[17,12],'q',[17,21],[10,21]]},
        '1': {w:20,n:3,d:['m',[6,17],'q',[8,18],[11,21],'l',[11,0]]},
        '2': {w:20,n:5,d:['m',[17,0],'l',[3,0],[13,10],'q',[16,13],[16,16],'q',[16,21],[10,21],'q',[4,21],[4,16]]},
        '3': {w:20,n:5,d:['m',[5,21],'l',[16,21],[10,14],'q',[17,14],[17,7],'q',[17,0],[10,0],'q',[5,0],[3,4]]},
        '4': {w:20,n:2,d:['m',[13,0],'l',[13,21],[3,7],[18,7]]},
        '5': {w:20,n:6,d:['m',[15,21],'l',[5,21],[4,12],'q',[5,14],[10,14],'q',[17,14],[17,7],'q',[17,0],[10,0],'q',[5,0],[3,4]]},
        '6': {w:20,n:8,d:['m',[16,18],'q',[15,21],[10,21],'q',[3,21],[3,12],'l',[3,7],'q',[3,0],[10,0],'q',[17,0],[17,7],'q',[17,13],[10,13],'q',[3,13],[3,7]]},
        '7': {w:20,n:2,d:['m',[3,21],'l',[17,21],[7,0]]},
        '8': {w:20,n:9,d:['m',[10,13],'q',[15,13],[15,17],'q',[15,21],[10,21],'q',[5,21],[5,17],'q',[5,13],[10,13],'q',[3,13],[3,7],'q',[3,0],[10,0],'q',[17,0],[17,7],'q',[17,13],[10,13]]},
        '9': {w:20,n:8,d:['m',[17,14],'q',[17,8],[10,8],'q',[3,8],[3,14],'q',[3,21],[10,21],'q',[17,21],[17,14],'l',[17,9],'q',[17,0],[10,0],'q',[5,0],[4,3]]},
        ':': {w:10,n:4,d:['m',[5,14],'l',[4,13],[5,12],[6,13],[5,14],'m',[5,2],'l',[4,1],[5,0],[6,1],[5,2]]},
        ';': {w:10,n:4,d:['m',[5,14],'l',[4,13],[5,12],[6,13],[5,14],'m',[6,1],'l',[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},
        '<': {w:24,n:2,d:['m',[20,18],'l',[4,9],[20,0]]},
        '=': {w:26,n:4,d:['m',[4,12],'l',[22,12],'m',[4,6],'l',[22,6]]},
        '>': {w:24,n:2,d:['m',[4,18],'l',[20,9],[4,0]]},
        '?': {w:18,n:8,d:['m',[3,16],'q',[3,21],[9,21],'q',[15,21],[15,16],'q',[15,11],[10,11],'q',[9,11],[9,10],'l',[9,7],'m',[9,2],'l',[8,1],[9,0],[10,1],[9,2]]},    
        '@': {w:27,n:17,d:['m',[21,3],'q',[20,1],[14,0],'l',[13,0],'q',[4,1],[3,10],'l',[3,11],'q',[4,20],[13,21],'l',[14,21],'q',[23,20],[24,11],'l',[24,10],'q',[24,6],[20,6],'q',[17,6],[18,10],'q',[18,6],[13,6],'q',[8,6],[9,11],'q',[10,15],[14,15],'q',[19,15],[18,10],'m',[18,10],'l',[19,14]]},
        'A': {w:18,n:6,d:['m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'B': {w:21,n:9,d:['m',[4,11],'l',[12,11],'m',[13,0],'l',[4,0],[4,21],[12,21],'q',[17,21],[17,16],'q',[17,11],[12,11],'q',[18,11],[18,6],'l',[18,5],'q',[18,0],[13,0]]},
        'C': {w:21,n:7,d:['m',[11,21],'q',[17,21],[18,16],'m',[18,5],'q',[17,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'D': {w:21,n:5,d:['m',[11,0],'l',[4,0],[4,21],[11,21],'q',[18,21],[18,12],'l',[18,9],'q',[18,0],[11,0]]},
        'E': {w:19,n:4,d:['m',[17,21],'l',[4,21],[4,0],[17,0],'m',[4,11],'l',[12,11]]},
        'F': {w:18,n:4,d:['m',[17,21],'l',[4,21],[4,0],'m',[4,11],'l',[12,11]]},
        'G': {w:21,n:8,d:['m',[11,21],'q',[17,21],[18,16],'m',[13,8],'l',[18,8],[18,5],'q',[17,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'H': {w:22,n:6,d:['m',[4,21],'l',[4,0],'m',[18,21],'l',[18,0],'m',[4,11],'l',[18,11]]},
        'I': {w:8,n:2,d:['m',[4,21],'l',[4,0]]},
        'J': {w:16,n:5,d:['m',[12,21],'l',[12,5],'q',[12,0],[7,0],'q',[2,0],[2,5],'l',[2,7]]},
        'K': {w:21,n:6,d:['m',[4,21],'l',[4,0],'m',[18,21],'l',[4,7],'m',[9,12],'l',[18,0]]},
        'L': {w:17,n:2,d:['m',[4,21],'l',[4,0],[16,0]]},
        'M': {w:24,n:2,d:['m',[4,0],'l',[4,21],[12,0],[20,21],[20,0]]},
        'N': {w:22,n:2,d:['m',[4,0],'l',[4,21],[18,0],[18,21]]},
        'O': {w:22,n:7,d:['m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'P': {w:21,n:6,d:['m',[4,10],'l',[13,10],'q',[18,10],[18,15],'l',[18,16],'q',[18,21],[13,21],'l',[4,21],[4,0]]},
        'Q': {w:22,n:9,d:['m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21],'m',[12,4],'l',[18,-2]]},
        'R': {w:21,n:8,d:['m',[4,10],'l',[13,10],'q',[18,10],[18,15],'l',[18,16],'q',[18,21],[13,21],'l',[4,21],[4,0],'m',[13,10],'l',[18,0]]},
        'S': {w:20,n:8,d:['m',[16,18],'q',[15,21],[10,21],'q',[5,21],[4,17],'q',[3,12],[7,11],'l',[13,10],'q',[18,9],[17,4],'q',[16,0],[10,0],'q',[4,0],[3,4]]},
        'T': {w:16,n:4,d:['m',[8,21],'l',[8,0],'m',[1,21],'l',[15,21]]},
        'U': {w:22,n:5,d:['m',[4,21],'l',[4,6],'q',[4,0],[11,0],'q',[18,0],[18,6],'l',[18,21]]},
        'V': {w:18,n:2,d:['m',[1,21],'l',[9,0],[17,21]]},
        'W': {w:24,n:2,d:['m',[2,21],'l',[7,0],[12,21],[17,0],[22,21]]},
        'X': {w:20,n:4,d:['m',[3,21],'l',[17,0],'m',[17,21],'l',[3,0]]},
        'Y': {w:18,n:4,d:['m',[1,21],'l',[9,11],[17,21],'m',[9,11],'l',[9,0]]},
        'Z': {w:20,n:2,d:['m',[3,21],'l',[17,21],[3,0],[17,0]]},
        '[': {w:14,n:2,d:['m',[11,25],'l',[4,25],[4,-7],[11,-7]]},
        '\\': {w:14,n:2,d:['m',[0,21],'l',[14,-3]]},
        ']': {w:14,n:2,d:['m',[3,25],'l',[10,25],[10,-7],[3,-7]]},
        '^': {w:16,n:2,d:['m',[3,16],'l',[8,21],[13,16]]},
        '_': {w:16,n:2,d:['m',[0,-2],'l',[16,-2]]},
        '`': {w:10,n:2,d:['m',[6,21],'l',[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},
        'a': {w:19,n:10,d:['m',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'b': {w:19,n:10,d:['m',[4,21],'l',[4,0],'m',[10,14],'l',[9,14],'q',[6,14],[4,12],'m',[4,2],'q',[6,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'c': {w:18,n:10,d:['m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[15,11],'q',[14,14],[10,14]]},
        'd': {w:19,n:10,d:['m',[15,21],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'e': {w:18,n:8,d:['m',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[3,8],'l',[15,8],'q',[15,14],[9,14]]},
        'f': {w:12,n:5,d:['m',[10,21],'q',[5,21],[5,17],'l',[5,0],'m',[2,14],'l',[9,14]]},
        'g': {w:19,n:12,d:['m',[15,14],'l',[15,-2],'q',[15,-7],[10,-7],'q',[7,-7],[6,-6],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'h': {w:19,n:6,d:['m',[4,21],'l',[4,0],'m',[4,10],'q',[6,14],[11,14],'q',[15,14],[15,10],'l',[15,0]]},
        'i': {w: 8,n:4,d:['m',[3,21],'l',[4,20],[5,21],[4,22],[3,21],'m',[4,14],'l',[4,0]]},
        'j': {w:10,n:5,d:['m',[5,21],'l',[6,20],[7,21],[6,22],[5,21],'m',[6,14],'l',[6,-3],'q',[6,-8],[1,-7]]},
        'k': {w:17,n:6,d:['m',[4,21],'l',[4,0],'m',[14,14],'l',[4,4],'m',[8,8],'l',[15,0]]},
        'l': {w: 8,n:2,d:['m',[4,21],'l',[4,0]]},
        'm': {w:26,n:10,d:['m',[4,14],'l',[4,0],'m',[4,10],'q',[6,14],[10,14],'q',[13,14],[13,10],'l',[13,0],'m',[13,10],'q',[15,14],[19,14],'q',[22,14],[22,10],'l',[22,0]]},
        'n': {w:19,n:6,d:['m',[4,14],'l',[4,0],'m',[4,10],'q',[6,14],[11,14],'q',[15,14],[15,10],'l',[15,0]]},
        'o': {w:19,n:7,d:['m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'p': {w:19,n:10,d:['m',[4,14],'l',[4,-7],'m',[10,14],'l',[9,14],'q',[6,14],[4,12],'m',[4,2],'q',[6,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'q': {w:19,n:10,d:['m',[15,14],'l',[15,-7],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'r': {w:13,n:4,d:['m',[4,14],'l',[4,0],'m',[4,8],'q',[5,14],[12,14]]},
        's': {w:16,n:7,d:['m',[13,11],'q',[13,14],[8,14],'q',[3,14],[3,11],'q',[3,8],[8,7],'q',[13,6],[13,3],'q',[13,0],[8,0],'q',[3,0],[3,3]]},
        't': {w:12,n:5,d:['m',[5,21],'l',[5,4],'q',[5,-1],[10,0],'m',[2,14],'l',[9,14]]},
        'u': {w:19,n:6,d:['m',[4,14],'l',[4,4],'q',[4,0],[8,0],'q',[13,0],[15,4],'m',[15,14],'l',[15,0]]},
        'v': {w:16,n:2,d:['m',[2,14],'l',[8,0],[14,14]]},
        'w': {w:22,n:2,d:['m',[3,14],'l',[7,0],[11,14],[15,0],[19,14]]},
        'x': {w:17,n:4,d:['m',[3,14],'l',[14,0],'m',[14,14],'l',[3,0]]},
        'y': {w:16,n:5,d:['m',[2,14],'l',[8,0],'m',[14,14],'l',[8,0],'q',[5,-7],[1,-7]]},
        'z': {w:17,n:2,d:['m',[3,14],'l',[14,14],[3,0],[14,0]]},
        '{': {w:14,n:9,d:['m',[9,25],'q',[5,24],[5,20],'q',[5,17],[7,16],'q',[9,15],[8,12],'q',[7,9],[4,9],'q',[7,9],[8,6],'q',[9,3],[7,2],'q',[5,1],[5,-2],'q',[5,-6],[9,-7]]},
        '|': {w: 8,n:2,d:['m',[4,25],'l',[4,-7]]},
        '}': {w:14,n:9,d:['m',[5,25],'q',[9,24],[9,20],'q',[9,17],[7,16],'q',[5,15],[6,12],'q',[7,9],[10,9],'q',[7,9],[6,6],'q',[5,3],[7,2],'q',[9,1],[9,-2],'q',[9,-6],[5,-7]]},
        '~': {w:24,n:4,d:['m',[3,6],'q',[3,12],[10,10],'l',[14,8],'q',[21,4],[21,10]]},
        ' ': {w:16,n:1,d:[]},
        '¡': {w:10,n:4,d:['m',[5,10],'l',[5,-4],'m',[5,17],'l',[4,16],[5,15],[6,16],[5,17]]},
        '¢': {w:18,n:14,d:['m',[9,14],'l',[9,18],'m',[9,0],'l',[9,-4],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[15,11],'q',[14,14],[10,14]]},
        '£': {w:18,n:8,d:['m',[4,11],'l',[13,11],'m',[16,18],'q',[15,21],[11,21],'q',[5,21],[6,16],'q',[7,8],[6,2],'q',[5,0],[4,0],'l',[16,0]]},
        '¤': {w:19,n:13,d:['m',[15,3],'l',[17,1],'m',[15,13],'l',[17,15],'m',[5,3],'l',[3,1],'m',[5,13],'l',[3,15],'m',[10,14],'q',[4,14],[4,8],'q',[4,2],[10,2],'q',[16,2],[16,8],'q',[16,14],[10,14]]},
        '¥': {w:18,n:8,d:['m',[4,7],'l',[14,7],'m',[4,11],'l',[14,11],'m',[1,21],'l',[9,11],[17,21],'m',[9,11],'l',[9,0]]},
        '¦': {w: 8,n:4,d:['m',[4,25],'l',[4,12],'m',[4,6],'l',[4,-7]]},
        '§': {w:20,n:12,d:['m',[16,18],'q',[16,21],[10,21],'q',[4,21],[4,18],'q',[4,15],[10,14],'q',[16,13],[16,10],'q',[16,6],[10,7],'m',[10,14],'q',[4,15],[4,11],'q',[4,8],[10,7],'q',[16,6],[16,3],'q',[16,0],[10,0],'q',[4,0],[4,3]]},
        '¨': {w:16,n:4,d:['m',[4,25],'l',[4,23],'m',[12,25],'l',[12,23]]},
        '©': {w:27,n:15,d:['m',[18,13],'q',[17,15],[14,15],'q',[9,15],[9,11],'l',[9,10],'q',[9,6],[14,6],'q',[17,6],[18,8],'m',[24,10],'q',[24,0],[14,0],'l',[13,0],'q',[3,0],[3,10],'l',[3,11],'q',[3,21],[13,21],'l',[14,21],'q',[24,21],[24,11],'l',[24,10]]},
        'ª': {w:14,n:9,d:['m',[4,12],'l',[10,12],'m',[10,21],'l',[10,15],'m',[4,18],'q',[4,15],[7,15],'q',[10,15],[10,18],'q',[10,21],[7,21],'q',[4,21],[4,18]]},
        '«': {w:24,n:4,d:['m',[12,16],'l',[3,9],[12,2],'m',[21,16],'l',[12,9],[21,2]]},
        '¬': {w:22,n:2,d:['m',[4,12],'l',[18,12],[18,8]]},
        '­': {w:22,n:2,d:['m',[4,9],'l',[18,9]]},
        '®': {w:27,n:17,d:['m',[9,6],'l',[9,15],[16,15],'m',[9,10],'l',[16,10],[18,6],'m',[16,10],'q',[18,10],[18,12],'l',[18,13],'q',[18,15],[16,15],'m',[24,10],'q',[24,0],[14,0],'l',[13,0],'q',[3,0],[3,10],'l',[3,11],'q',[3,21],[13,21],'l',[14,21],'q',[24,21],[24,11],'l',[24,10]]},
        '¯': {w:16,n:2,d:['m',[0,24],'l',[16,24]]},
        '°': {w:10,n:5,d:['m',[3,23],'q',[3,21],[5,21],'q',[7,21],[7,23],'q',[7,25],[5,25],'q',[3,25],[3,23]]},
        '±': {w:22,n:6,d:['m',[11,18],'l',[11,6],'m',[4,12],'l',[18,12],'m',[4,2],'l',[18,2]]},
        '²': {w:14,n:6,d:['m',[10,11],'l',[4,11],'q',[4,15],[7,15],'q',[10,15],[10,18],'q',[10,21],[7,21],'q',[4,21],[4,18]]},
        '³': {w:14,n:5,d:['m',[4,14],'q',[4,11],[7,11],'q',[10,11],[10,14],'q',[10,17],[7,17],'l',[10,21],[4,21]]},
        '´': {w:19,n:2,d:['m',[9,18],'l',[12,20]]},
        'µ': {w:19,n:7,d:['m',[4,14],'l',[4,-6],'m',[4,4],'q',[4,0],[8,0],'q',[13,0],[15,4],'m',[15,14],'l',[15,0]]},
        '¶': {w:18,n:5,d:['m',[8,11],'q',[3,11],[3,16],'q',[3,21],[9,21],'m',[9,0],'l',[9,21],[15,21],[15,0]]},
        '·': {w:10,n:2,d:['m',[5,14],'l',[4,13],[5,12],[6,13],[5,14]]},
        '¸': {w:18,n:2,d:['m',[10,0],'l',[10,-2],[7,-4]]},
        '¹': {w:10,n:2,d:['m',[4,19],'l',[6,21],[6,11]]},
        'º': {w:14,n:7,d:['m',[4,12],'l',[10,12],'m',[4,18],'q',[4,15],[7,15],'q',[10,15],[10,18],'q',[10,21],[7,21],'q',[4,21],[4,18]]},
        '»': {w:24,n:4,d:['m',[3,16],'l',[12,9],[3,2],'m',[12,16],'l',[21,9],[12,2]]},
        '¼': {w:24,n:6,d:['m',[4,19],'l',[6,21],[6,11],'m',[16,15],'l',[6,5],'m',[19,0],'l',[19,10],[14,4],[20,4]]},
        '½': {w:24,n:10,d:['m',[4,19],'l',[6,21],[6,11],'m',[16,15],'l',[6,5],'m',[20,0],'l',[14,0],'q',[14,4],[17,4],'q',[20,4],[20,7],'q',[20,10],[17,10],'q',[14,10],[14,7]]},
        '¾': {w:24,n:10,d:['m',[4,14],'q',[4,11],[7,11],'q',[10,11],[10,14],'q',[10,17],[7,17],'l',[10,21],[4,21],'m',[18,15],'l',[8,5],'m',[19,0],'l',[19,10],[14,4],[20,4]]},
        '¿': {w:18,n:7,d:['m',[9,21],'l',[8,20],[9,19],[10,20],[9,21],'m',[9,14],'l',[9,10],'q',[3,10],[3,5],'q',[3,0],[9,0],'q',[15,0],[15,5]]},    
        'À': {w:18,n:6,d:['m',[7,25],'l',[10,23],'m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'Á': {w:18,n:6,d:['m',[8,23],'l',[11,25],'m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'Â': {w:18,n:6,d:['m',[7,23],'l',[9,25],[11,23],'m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'Ã': {w:18,n:6,d:['m',[6,23],'l',[8,25],[10,23],[12,25],'m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'Ä': {w:18,n:10,d:['m',[5,25],'l',[5,23],'m',[13,25],'l',[13,23],'m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'Å': {w:18,n:10,d:['m',[7,23],'q',[7,21],[9,21],'q',[11,21],[11,23],'q',[11,25],[9,25],'q',[7,25],[7,23],'m',[1,0],'l',[9,21],[17,0],'m',[4,7],'l',[14,7]]},
        'Æ': {w:18,n:12,d:['m',[9,21],'l',[1,0],'m',[4,7],'l',[9,7],'m',[9,21],'l',[9,0],'m',[9,21],'l',[17,21],'m',[9,11],'l',[17,11],'m',[9,0],'l',[17,0]] },
        'Ç': {w:21,n:9,d:['m',[11,0],'l',[11,-2],[8,-4],'m',[11,21],'q',[17,21],[18,16],'m',[18,5],'q',[17,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'È': {w:19,n:8,d:['m',[7,25],'l',[10,23],'m',[17,21],'l',[4,21],[4,0],[17,0],'m',[4,11],'l',[12,11]]},
        'É': {w:19,n:8,d:['m',[9,23],'l',[12,25],'m',[17,21],'l',[4,21],[4,0],[17,0],'m',[4,11],'l',[12,11]]},
        'Ê': {w:19,n:8,d:['m',[8,23],'l',[10,25],[12,23],'m',[17,21],'l',[4,21],[4,0],[17,0],'m',[4,11],'l',[12,11]]},
        'Ë': {w:19,n:10,d:['m',[6,25],'l',[6,23],'m',[15,25],'l',[15,23],'m',[17,21],'l',[4,21],[4,0],[17,0],'m',[4,11],'l',[12,11]]},
        'Ì': {w:8,n:4,d:['m',[3,25],'l',[6,23],'m',[4,21],'l',[4,0]]},
        'Í': {w:8,n:4,d:['m',[2,23],'l',[5,25],'m',[4,21],'l',[4,0]]},
        'Î': {w:8,n:4,d:['m',[2,23],'l',[4,25],[6,23],'m',[4,21],'l',[4,0]]},
        'Ï': {w:8,n:6,d:['m',[2,25],'l',[2,23],'m',[6,25],'l',[6,23],'m',[4,21],'l',[4,0]]},
        'Ð': {w:21,n:7,d:['m',[2,10],'l',[11,10],'m',[11,0],'l',[4,0],[4,21],[11,21],'q',[18,21],[18,12],'l',[18,9],'q',[18,0],[11,0]]},
        'Ñ': {w:22,n:4,d:['m',[8,23],'l',[10,25],[12,23],[14,25],'m',[4,0],'l',[4,21],[18,0],[18,21]]},
        'Ò': {w:22,n:9,d:['m',[8,25],'l',[11,23],'m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'Ó': {w:22,n:9,d:['m',[10,23],'l',[13,25],'m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'Ô': {w:22,n:9,d:['m',[9,23],'l',[11,25],[13,23],'m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'Õ': {w:22,n:9,d:['m',[8,23],'l',[10,25],[12,23],[14,25],'m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'Ö': {w:22,n:13,d:['m',[6,25],'l',[6,23],'m',[16,25],'l',[16,23],'m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        '×': {w:12,n:4,d:['m',[2,16],'l',[10,6],'m',[10,16],'l',[2,6]]},
        'Ø': {w:22,n:9,d:['m',[3,1],'l',[19,20],'m',[11,21],'q',[19,21],[19,12],'l',[19,9],'q',[19,0],[11,0],'q',[3,0],[3,9],'l',[3,12],'q',[3,21],[11,21]]},
        'Ù': {w:22,n:7,d:['m',[8,25],'l',[11,23],'m',[4,21],'l',[4,6],'q',[4,0],[11,0],'q',[18,0],[18,6],'l',[18,21]]},
        'Ú': {w:22,n:7,d:['m',[10,23],'l',[13,25],'m',[4,21],'l',[4,6],'q',[4,0],[11,0],'q',[18,0],[18,6],'l',[18,21]]},
        'Û': {w:22,n:7,d:['m',[9,23],'l',[11,25],[13,23],'m',[4,21],'l',[4,6],'q',[4,0],[11,0],'q',[18,0],[18,6],'l',[18,21]]},
        'Ü': {w:22,n:9,d:['m',[7,25],'l',[7,23],'m',[15,25],'l',[15,23],'m',[4,21],'l',[4,6],'q',[4,0],[11,0],'q',[18,0],[18,6],'l',[18,21]]},
        'Ý': {w:18,n:6,d:['m',[8,23],'l',[11,25],'m',[1,21],'l',[9,11],[9,0],'m',[17,21],'l',[9,11]]},
        'Þ': {w:19,n:7,d:['m',[4,18],'l',[4,-5],'m',[4,14],'l',[9,14],'q',[16,14],[16,7],'q',[16,0],[9,0],'l',[4,0]]},
        'ß': {w:21,n:9,d:['m',[8,0],'l',[11,0],'q',[17,0],[17,5],'l',[17,6],'q',[17,10],[11,12],'q',[16,13],[16,16],'q',[16,21],[10,21],'q',[4,21],[4,16],'l',[4,0]]},
        'à': {w:19,n:12,d:['m',[7,20],'l',[10,18],'m',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'á': {w:19,n:12,d:['m',[9,18],'l',[12,20],'m',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'â': {w:19,n:12,d:['m',[7,18],'l',[9,20],[11,18],'m',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'ã': {w:19,n:12,d:['m',[7,18],'l',[9,20],[11,18],[13,20],'m',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'ä': {w:19,n:14,d:['m',[4,20],'l',[4,18],'m',[15,20],'l',[15,18],'m',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'å': {w:19,n:15,d:['m',[7,18],'q',[7,16],[9,16],'q',[11,16],[11,18],'q',[11,20],[9,20],'q',[7,20],[7,18],  'm',[15,14],'l',[15,0],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[13,0],[15,2],'m',[15,12],'q',[13,14],[10,14]]},
        'æ': {w:21,n:10,d:['m',[11,14],'l',[11,0],'m',[11,8],'l',[18,8],'q',[18,14],[12,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[13,0],'q',[17,0],[18,3]]},
        'ç': {w:18,n:10,d:['m',[10,0],'l',[10,-2],[7,-4],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[15,11],'q',[14,14],[10,14]]},
        'è': {w:18,n:10,d:['m',[7,20],'l',[10,18],'m',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[3,8],'l',[15,8],'q',[15,14],[9,14]]},
        'é': {w:18,n:10,d:['m',[9,18],'l',[12,20],'m',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[3,8],'l',[15,8],'q',[15,14],[9,14]]},
        'ê': {w:18,n:10,d:['m',[7,18],'l',[9,20],[11,18],'m',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[3,8],'l',[15,8],'q',[15,14],[9,14]]},
        'ë': {w:18,n:12,d:['m',[4,20],'l',[4,18],'m',[15,20],'l',[15,18],'m',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[14,0],[15,3],'m',[3,8],'l',[15,8],'q',[15,14],[9,14]]},
        'ì': {w:8,n:4,d:['m',[3,20],'l',[6,18],'m',[4,14],'l',[4,0]]},
        'í': {w:8,n:4,d:['m',[2,18],'l',[5,20],'m',[4,14],'l',[4,0]]},
        'î': {w:8,n:4,d:['m',[2,18],'l',[4,20],[6,18],'m',[4,14],'l',[4,0]]},
        'ï': {w:8,n:6,d:['m',[2,20],'l',[2,18],'m',[6,20],'l',[6,18],'m',[4,14],'l',[4,0]]},
        'ð': {w:19,n:12,d:['m',[8,17],'l',[10,21],'m',[7,20],'l',[11,18],'q',[16,16],[16,8],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'ñ': {w:19,n:8,d:['m',[7,18],'l',[9,20],[11,18],[13,20],'m',[4,14],'l',[4,0],'m',[4,10],'q',[6,14],[11,14],'q',[15,14],[15,10],'l',[15,0]]},
        'ò': {w:19,n:9,d:['m',[7,20],'l',[10,18],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'ó': {w:19,n:9,d:['m',[9,18],'l',[12,20],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'ô': {w:19,n:9,d:['m',[7,18],'l',[9,20],[11,18],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'õ': {w:19,n:9,d:['m',[7,18],'l',[9,20],[11,18],[13,20],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'ö': {w:19,n:11,d:['m',[4,20],'l',[4,18],'m',[15,20],'l',[15,18],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        '÷': {w:18,n:6,d:['m',[9,15],'l',[9,14],'m',[4,9],'l',[14,9],'m',[9,4],'l',[9,3]]},
        'ø': {w:19,n:9,d:['m',[3,1],'l',[15,14],'m',[10,14],'l',[9,14],'q',[3,14],[3,7],'q',[3,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'ù': {w:19,n:8,d:['m',[7,20],'l',[10,18],'m',[4,14],'l',[4,4],'q',[4,0],[8,0],'q',[13,0],[15,4],'m',[15,14],'l',[15,0]]},
        'ú': {w:19,n:8,d:['m',[9,18],'l',[12,20],'m',[4,14],'l',[4,4],'q',[4,0],[8,0],'q',[13,0],[15,4],'m',[15,14],'l',[15,0]]},
        'û': {w:19,n:8,d:['m',[7,18],'l',[9,20],[11,18],'m',[4,14],'l',[4,4],'q',[4,0],[8,0],'q',[13,0],[15,4],'m',[15,14],'l',[15,0]]},
        'ü': {w:19,n:10,d:['m',[4,20],'l',[4,18],'m',[15,20],'l',[15,18],'m',[4,14],'l',[4,4],'q',[4,0],[8,0],'q',[13,0],[15,4],'m',[15,14],'l',[15,0]]},
        'ý': {w:16,n:7,d:['m',[7,18],'l',[10,20],'m',[2,14],'l',[8,0],'m',[14,14],'l',[8,0],'q',[5,-7],[1,-7]]},
        'þ': {w:19,n:10,d:['m',[4,21],'l',[4,-7],'m',[10,14],'l',[9,14],'q',[6,14],[4,12],'m',[4,2],'q',[6,0],[9,0],'l',[10,0],'q',[16,0],[16,7],'q',[16,14],[10,14]]},
        'ÿ': {w:16,n:9,d:['m',[2,20],'l',[2,18],'m',[14,20],'l',[14,18],'m',[2,14],'l',[8,0],'m',[14,14],'l',[8,0],'q',[5,-7],[1,-7]]}
    };
    
    // Main Tetris game code from tetris3.js
    var TETRIS = new function () { // namespacing
        
        function random_det(seed) {
          return function() {
            // Robert Jenkins' 32 bit integer hash function.
            seed = ((seed + 0x7ed55d16) + (seed << 12))  & 0xffffffff;
            seed = ((seed ^ 0xc761c23c) ^ (seed >>> 19)) & 0xffffffff;
            seed = ((seed + 0x165667b1) + (seed << 5))   & 0xffffffff;
            seed = ((seed + 0xd3a2646c) ^ (seed << 9))   & 0xffffffff;
            seed = ((seed + 0xfd7046c5) + (seed << 3))   & 0xffffffff;
            seed = ((seed ^ 0xb55a4f09) ^ (seed >>> 16)) & 0xffffffff;
            //return (seed >>> 0) / 0xffffffff;
            return (seed >>> 0); 
          };
        }
        
        // generator to mod PRNG by 7
        function random_det_7(seed) {
          var gen = random_det(seed);
          return function () { 
            return gen()%7;
          };
        }
        
        // generator to produce a permutation of 0..7 -- returns array
        // this is a fisher yates shuffle
        function random_perm_7(seed) {
          var gen = random_det(seed);
          var arr = [0,1,2,3,4,5,6];
          return function () {
            var i;
            for(i=6;i>0;i--) {
              var j = gen()%(i+1);
              var tmp = arr[j];
              arr[j] = arr[i];
              arr[i] = tmp;
              // todo: change to xor swap
            }
            return arr;
          };
        }
        
        function random_perm_single(seed) {
          var gen = random_perm_7(seed);
          var curPerm = gen(); // i dont like this unnecessary duplicating of state
          var which = -1;
          return function () {    
            which += 1;
            if (which >= 7) { curPerm = gen(); which = 0;}
            return curPerm[which];
          };
        }
        
        var board = [];
        var i=0;
        for (i=0;i<240;i++) {
            board[i] = 0;
        }
        var xoff = 8;
        var yoff = 8;
        var xsize = 15;
        var ysize = 15;
        var gapsize = 2;
        var bordersize = 2;
        // white, red, green, blue, purple, yellow, orange, cyan
        // None,  Z,   S,     J,    T,      O,      L,      I
        var colors = ["#999","#F00","#0F0",
                      "#22F","#F0F", "#FF0",
                      "#F70","#0EE"];
        function drawBox(position, value, context) {
          var i = position % 10;
          var j = (position-i) / 10;
          drawBox2(i,j,value,context);
        }
        function drawBox2(posX,posY,value,context) {
          context.fillStyle = colors[value];
          context.fillRect(xoff + posX*(xsize+gapsize), yoff+posY*(ysize+gapsize),xsize,ysize);
        }
        function drawSingleBlock(x,y,context) {
          context.fillRect(x,y,xsize,ysize);
        }
        function drawBoard(boardArr, context) {
          var i;
          context.fillStyle = "#000";
          context.fillRect(0,0,xoff*2 + xsize*10 + gapsize*9,yoff*2+ysize*24+gapsize*23);
          context.clearRect(xoff-bordersize,yoff-bordersize,(xsize+gapsize)*10-gapsize+bordersize*2,(ysize+gapsize)*24-gapsize+bordersize*2);
          context.strokeRect(xoff-.5,yoff-.5,(xsize+gapsize)*10-gapsize+1,(ysize+gapsize)*24-gapsize+1);
          context.fillStyle = "#888";
          context.fillRect(xoff,yoff,(xsize+gapsize)*10-gapsize,(ysize+gapsize)*24-gapsize);
          for(i=0;i<240;i++){
            drawBox(i,board[i],context);
          }
        }
        var positionFromLeft = 0;
        function updateSizing() {
          xsize = ysize = Math.floor((window.innerHeight - 25 - yoff*2 - 24*gapsize) / 24.0);
          //gapsize = Math.floor((window.innerHeight - 150) / 300);
          var bc = document.getElementById('board_canvas');
          var ac = document.getElementById('animated_canvas');
          var sc = document.getElementById('shadow_canvas');
          //var ph = document.getElementById('placeholder');
          var score_el = document.getElementById('score-container');
          bc.width = ac.width = sc.width = (xoff*2 + xsize*10 + gapsize*9);
          bc.height = ac.height = sc.height = (yoff*2 + ysize*24 + gapsize*23);
          //ph.style.height = (yoff*2+ysize*24+gapsize*23)+"px";
          //ph.style.width = ((xoff*2 + xsize*10 + gapsize*9)+180)+"px";
          
          
            document.getElementById('instructions').style.marginLeft = (bc.width)+"px";
            document.getElementById('instr').ontouchmove = function (e) { // prevent touchmove default scroll behavior on all but the instr text section
                e.stopPropagation(); 
            }
          
          
          // this is to set the absolute positioning in the center of the window.
          // note -- window.innerWidth/Height not supported by IE
          positionFromLeft = 10;//Math.floor((window.innerWidth - (xoff*2 + xsize*10 + gapsize*9) - 20)/2.0);
          bc.style.left = ac.style.left = sc.style.left = positionFromLeft + "px"; 
          
          score_el.style.left = positionFromLeft+bc.width+10+"px";
        
            document.getElementById('instructions').style.top = score_el.clientHeight + 20 + "px";
          
          
          var ctx1 = document.getElementById('board_canvas').getContext('2d');
          drawBoard(board,ctx1);
          updatePiece();
          updateShadow();
          if (paused) drawPaused();
        }
        
        function clearRowCheck(startrow, numrowsdown) {
          var i;
          var numRowsCleared = 0;
          for (i=0;i<numrowsdown;i++) {
            var j;
            var full = true;
            for (j=0;j<10;j++) {
              if (!board[(startrow+i)*10+j]) full = false;
            }
            if (full) { numRowsCleared++; shiftDown(startrow+i);  var ctx1 = document.getElementById('board_canvas').getContext('2d'); drawBoard(board,ctx1);}
          }
          if (numRowsCleared == 1) {applyScore(100);}
          else if (numRowsCleared == 2) {applyScore(300);}
          else if (numRowsCleared == 3) {applyScore(500);}
          else if (numRowsCleared == 4) {applyScore(800);}
          
          // Update level based on score
          updateLevel();
        }
        // row is full
        function shiftDown(row) {
          var i;
          for(i=row*10-1;i>=0;i--) {
            board[i+10] = board[i];
          }
          for(i=0;i<10;i++) {
           board[i]=0;
          }
        }
        
        var autoMoveDownInterval = "";
        var animationUpdateInterval = "";
        var mouseControlInterval = "";
        function moveDownIntervalFunc () {
          moves[7]();
          updatePiece();
        } 
        function animationUpdateIntervalFunc() {
            // move animPositions closer to their targets (piece positions)
            animPositionX += (pieceX - animPositionX)*.3;
            animPositionY += (pieceY - animPositionY)*.3;
            // move animRotation closer to zero
            animRotation -= animRotation * 0.3;
            updatePiece();
        }
        function mouseControlFunc() {}
        var isMouseControl = false;
        var mouseControlX = 0; // use this to draw helper arrow
        function toggleMouseControl () {
          if (isMouseControl) { mouseControlFunc = function () {}; document.oncontextmenu = null; } 
          else {mouseControlFunc = function () {
            //var posIn = posx-positionFromLeft; 
            //if (posIn > xoff && posIn < (xoff + xsize*10 + gapsize*9))
            //{
              mouseControlX = (posx / window.innerWidth)*11.5-2.5;
              //document.title = off;
              if (pieceX > mouseControlX+.5) moves[0](); 
              if (pieceX < mouseControlX-.5) moves[2]();
              
            //} else {  }
          };
          document.oncontextmenu = function () { return false; };  
          }
          isMouseControl = !isMouseControl;
        }
        
        var paused = false;
        function isPaused() {
            return paused;
        }
        
        
        function drawPaused() {
          var ctx = document.getElementById("animated_canvas").getContext('2d');
          var offset = xoff;
          var size = (xsize +gapsize*.9)*2.05;
          var yoffset = yoff + (xsize+gapsize)*10;
          ctx.strokeStyle = "#FFF";
          ctx.strokeText("PAUSED",offset,yoffset,size,160);
          ctx.strokeStyle = "#000";
          ctx.strokeText("PAUSED",offset,yoffset,size,100);
        }
        var setPause = function(isendgame) {
          //console.log("setPause invoked", paused);
          if (paused) return;
          clearInterval(autoMoveDownInterval); 
          autoMoveDownInterval = "";
          clearInterval(animationUpdateInterval);
          animationUpdateInterval = "";
          clearInterval(mouseControlInterval);
          mouseControlInterval = "";
          //document.title = "Tetris! GAME OVER";
          if (!isendgame) { drawPaused(); document.title="Tetris! PAUSED";
          }
          paused = true;
          pausedBecauseLostFocus = false; // default this to false
           
        }
        
        
        function unPause() {
          if (!paused) return;
          if (autoMoveDownInterval == "") {
            autoMoveDownInterval = setInterval(moveDownIntervalFunc,300);
          }
          if (animationUpdateInterval == "") {
            animationUpdateInterval = setInterval(animationUpdateIntervalFunc,16);
          }
          if (mouseControlInterval == "") {
            mouseControlInterval = setInterval(mouseControlFunc,100); //function indirection
          }
          paused = false;
          pausedBecauseLostFocus = false; // default this to false
          document.title = "Tetris!"; 
          // chrome doesn't seem to update titlebar correctly sometimes. similar thing in safari.
          // Can't figure out a way to force it. Works great in FF.
        }
        
        var control_accum = [-1,-1];
        
        var xMoveThreshold = 30;
        var yMoveThreshold = 30;
        
        var hardDropYDistanceThreshold = 35; // 150 px seems reasonable
        var hardDropGestureTime = 300; 
        var hardDropYAccAtPreviousTimes = []; // stores path
        
        function hardDropTest(x,y) {
            // only when user lifts control finger and the parameter thresholds are met
            // will the hard drop command be sent. 
            if (hardDropYAccAtPreviousTimes.length > 2) {
                var now = new Date().getTime();
                if (now - lastFixTime > hardDropGestureTime) {
                    for (var i = hardDropYAccAtPreviousTimes.length-1; i >= 0; --i) {
                        if ((now - hardDropYAccAtPreviousTimes[i][1]) < hardDropGestureTime) {
                            if ((y - hardDropYAccAtPreviousTimes[i][0]) > hardDropYDistanceThreshold) {
                                moves[6]();
                                return;
                            } //else { console.log("not enough dist "+(y - hardDropYAccAtPreviousTimes[i][0])); }
                        } //else { console.log("too much time "+(now - hardDropYAccAtPreviousTimes[i][1])); }
                    }
                    //console.log("Not quite enough for hard drop: "+ flatten(hardDropYAccAtPreviousTimes)+" timediff = "+ (now-hardDropYAccAtPreviousTimes[0][1]) +" y = "+y);
                }
            }
            hardDropYAccAtPreviousTimes = [];
        }
        
        // all of the control finger data has been handled for us in touchevent callbacks
        // and this function is called only when necessary (control finger moved)
        function Control(newpos) {
        
            if (paused) return;
        
            var cl = control_location;
            var delta = [newpos[0]-cl[0],newpos[1]-cl[1]];
            control_accum = [control_accum[0]+delta[0],control_accum[1]+delta[1]];
        
            var thresh_sq = 50; // square of pixels travel which is to cancel tap. 
            if (touchlist.length == 1 && control_accum[0]*control_accum[0]+control_accum[1]*control_accum[1] > thresh_sq) {
                lastTouchStartTime = 0; // cancel the tap "gesture"
            }
            // game control logic 
            while (control_accum[0] > xMoveThreshold) { control_accum[0] -= xMoveThreshold; moves[2](); hardDropYAccAtPreviousTimes = []; }
            while (control_accum[0] <-xMoveThreshold) { control_accum[0] += xMoveThreshold; moves[0](); hardDropYAccAtPreviousTimes = []; }
        
            while (control_accum[1] > yMoveThreshold) { control_accum[1] -= yMoveThreshold; moves[3](); }
            
            hardDropYAccAtPreviousTimes.push([newpos[1], new Date().getTime()]);
        
            control_location[0] = newpos[0];
            control_location[1] = newpos[1];
        }
        
        var actually_draw_touches = false;
        
        
        function drawTouches() { // Not really drawing so much as managing and moving a list of DOM elems so they match touchlist -- it *functions* like drawing
            // This function serves to transparently create and manage the
            // touch visualization elements requiring only trivial processing
            // of events in a separate part of code
        
            if (!actually_draw_touches) return;
        
            var indicator_container = document.getElementById('indicatorcontainer');
        
                // removes any DOM indicator which is not (no longer) in touchlist
            for (var i = 0; i < indicator_container.childNodes.length; i++) {
                var found = false;
                for (var j=0;j<touchlist.length;++j) {
                    if (touchlist[j].identifier == indicator_container.childNodes[i].innerHTML.replace(/^(.*)@.*$/,'$1')) {
                        found = true;
                    }
                }
                if (!found) {
                    indicator_container.removeChild(indicator_container.childNodes[i]); i--;
                    //console.log("removed finger child #"+(i+1));
                }
            }
        
            // updates the remaining DOM indicators with updated positioning
            for (var i=0; i < touchlist.length; ++i) { 
                // the touchlist caches the quickly updated data 
                // TODO: store efficient touchlist
                var found = false;
                for (var j=0;j<indicator_container.childNodes.length;j++) {
                    var thisf = indicator_container.childNodes[j];
                    //console.log(thisf.innerHTML.replace(/(.*)@.*/,'$1'))
                    if (thisf.innerHTML.replace(/^(.*)@.*$/,'$1') == touchlist[i].identifier) {
                        thisf.style.webkitTransform = 'translate('+touchlist[i].clientX+'px, '+touchlist[i].clientY+'px)';
                        thisf.innerHTML = touchlist[i].identifier + "@ " + touchlist[i].clientX +", "+ touchlist[i].clientY;
                        found = true;
                        if (touchlist[i].identifier == control_finger_id) {
                            thisf.setAttribute('class', 'finger-indicator control');
                        }
                    }
                    
                }
                // creates new DOM indicators if there are new fingers
                if (!found) {
                    var new_indicator = document.createElement('span'); 
                    new_indicator.innerHTML = touchlist[i].identifier + "@ " + touchlist[i].clientX +", "+ touchlist[i].clientY;
                    new_indicator.style.webkitTransform = 'translate('+touchlist[i].clientX+'px, '+touchlist[i].clientY+'px)';
                    new_indicator.setAttribute('class','finger-indicator');
                    if (touchlist[i].identifier == control_finger_id) {
                        new_indicator.setAttribute('class', 'finger-indicator control');
                    }
                    indicator_container.appendChild(new_indicator);
                    //console.log("adding finger child #"+(indicator_container.childNodes.length-1));
                }
            }
            
        }
        window.onload = function () { win_onload(); }; 
        
        function win_onload() {
          next();
          applyScore(0); // to init
          setPause(false);
          unPause();
          
          var animCtx = document.getElementById('animated_canvas').getContext('2d');
          set_textRenderContext(animCtx);
          if (check_textRenderContext(animCtx)) {
            
          } else {
            //alert("No text available"); 
          }
            
          // required to make the range actually settable 
          updateSizing();  
        }
        
        // coordinate systems follow convention starting at top-left. 
        // order is that of clockwise rotation.
        // row-major layout.
        // currently using SRS rotation; I am not satisfied with 
        // the S, Z, I having 4 states when they only need two, 
        // but I would need to have them rotate on an axis that changes
        // location depending on orientation and cw vs ccw rotation. 
        // todo: Implement this :) --- hopefully without enumerating
        // all possible cases
        var tetromino_Z = [[[1,1],[0,1,1]],[[0,0,1],[0,1,1],[0,1]],[[],[1,1],[0,1,1]],[[0,1],[1,1],[1]]];
        var tetromino_S = [[[0,2,2],[2,2]],[[0,2],[0,2,2],[0,0,2]],[[],[0,2,2],[2,2]],[[2],[2,2],[0,2]]];
        var tetromino_J = [[[3],[3,3,3]],[[0,3,3],[0,3],[0,3]],[[],[3,3,3],[0,0,3]],[[0,3],[0,3],[3,3]]];
        var tetromino_T = [[[0,4],[4,4,4]],[[0,4],[0,4,4],[0,4]],[[],[4,4,4],[0,4]],[[0,4],[4,4],[0,4]]];
        var tetromino_O = [[[5,5],[5,5]]];
        var tetromino_L = [[[0,0,6],[6,6,6]],[[0,6],[0,6],[0,6,6]],[[],[6,6,6],[6]],[[6,6],[0,6],[0,6]]];
        var tetromino_I = [[[],[7,7,7,7]],[[0,0,7],[0,0,7],[0,0,7],[0,0,7]],[[],[],[7,7,7,7]],[[0,7],[0,7],[0,7],[0,7]]];
        // tetromino geometry data
        var tetrominos = [tetromino_Z,tetromino_S,tetromino_J,tetromino_T,tetromino_O,tetromino_L,tetromino_I];
        // this is for the rotation animation -- must know where in local
        // grid did the piece rotate around
        // each coordinate is a triple, the first two are x,y, and 
        // the last is to indicate whether the point is in the center
        // of the block or in the corner to the bottom right between 
        // blocks. These are the points which may be rotated around
        // to retain block alignment, if that makes any sense. 
        var tet_center_rot = [[1,1,true],[1,1,true],[1,1,true],[1,1,true],[0,0,false],[1,1,true],[1,1,false]];
        
        var pieceX=3;
        var pieceY=0;
        var curPiece=0;
        var curRotation=0;
        
        
        function drawMessage(messageString, size) {
          var ctx = document.getElementById("animated_canvas").getContext('2d');
          var offset = xoff;
          var size = (xsize +gapsize*.9)*size;
          var yoffset = yoff + (xsize+gapsize)*10;
          ctx.strokeStyle = "#FFF";
          ctx.strokeText(messageString,offset,yoffset,size,160);
          ctx.strokeStyle = "#000";
          ctx.strokeText(messageString,offset,yoffset,size,100);
        }
        
        function clearContext(ctx, width, height) {
            // Store the current transformation matrix
            ctx.save();
        
            // Use the identity matrix while clearing the canvas
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, width, height);
        
            // Restore the transform
            ctx.restore(); 
        }
        
        function gameWin() {
          var sc = document.getElementById('shadow_canvas');
          clearContext(sc.getContext('2d'),sc.width,sc.height);
          var ac = document.getElementById('animated_canvas');
          clearContext(ac.getContext('2d'),ac.width,ac.height);
          drawMessage("You Win!", 1.45);
          setPause(true);
        }
        function gameOver() {
          drawMessage("Game Over", 1.45);
          setPause(true);
          //Cleanup
        
        }
        
        var objPos = {x:0, y:0};
        var lockTimer = "";
        var generator = random_perm_single(Math.floor((new Date()).getTime() / 1000));
        function next() {
          pieceX = 3;
          pieceY = 0;
          animPositionX = pieceX;
          animPositionY = pieceY;
          curRotation = 0;
          curPiece = generator();
          if (kick()) {
            gameOver();
          }
          updateShadow();
        }
        
        
        var lastFixTime = 0;
        
        function fixPiece() {
            lastFixTime = new Date().getTime();
          var i,j;
          var tetk = tetrominos[curPiece][curRotation];
          for (j=0;j<tetk.length;j++) {
            var tetkj = tetk[j];
            for (i=0;i<tetkj.length;i++) {
              var tetkji = tetkj[i];
              var pxi = pieceX+i;
              var pyj = pieceY+j;
              if (tetkji)
              {
                board[pyj*10+pxi] = tetkji;
              }
            }
          }
          drawBoard(board,document.getElementById('board_canvas').getContext('2d'));
          // will hardcode this behavior for now
          clearRowCheck(pieceY,tetrominos[curPiece][curRotation].length);
          next();
        }
        
        function isPieceInside() {
          var i,j;
          var tetk = tetrominos[curPiece][curRotation];
          for (j=0;j<tetk.length;j++) {
            var tetkj = tetk[j];
            for (i=0;i<tetkj.length;i++) {
              var tetkji = tetkj[i];
              var pxi = pieceX+i;
              var pyj = pieceY+j;
              if (tetkji && (pxi < 0 || pyj < 0 || pxi > 9 || pyj > 23)) {
                //document.getElementById('msg').innerHTML += "<br>pxi,pyj="+pxi+","+pyj+"i,j="+i+","+j+"tetkji="+tetkji;
                return 1;
              }
              if (tetkji && board[pyj*10+pxi]) {
                return 2; 
              }
            }
          }
          return 0;
        }
        moves = [
          // left
          function () {if (freezeInteraction) return; pieceX -= 1; if (isPieceInside()) pieceX += 1; shiftright = 0; updateShadow(); clearLockTimer();},
          // up direction movement is a cheat in standard tetris
          function () {if (freezeInteraction) return; pieceY -= 1; if (isPieceInside()) pieceY += 1; clearLockTimer();},
          // right
          function () {if (freezeInteraction) return; pieceX += 1; if (isPieceInside()) pieceX -= 1; shiftright = 1; updateShadow(); clearLockTimer();},
          // down key calls this -- moves stuff down, if at bottom, locks it
          function () {
            if (freezeInteraction) return;
            pieceY += 1; 
            if (isPieceInside()) { 
              pieceY -= 1;
              fixPiece();      
            } else {
                // Add 1 point per cell for soft drop
                applyScore(1);
            }
            clearLockTimer();
          },
          // rotate clockwise
          function () {
            if (freezeInteraction) return;
            var oldrot = curRotation; 
            curRotation = (curRotation+1)%(tetrominos[curPiece].length);
            if (kick()) curRotation = oldrot; 
            else animRotation = -Math.PI/2.0;
            updateShadow();
            clearLockTimer();
          },
          // rotate ccw
          function () {
            if (freezeInteraction) return;
            var oldrot = curRotation;
            var len = tetrominos[curPiece].length;
            curRotation = (curRotation-1+len)%len;
            if (kick()) curRotation = oldrot;
            else animRotation = Math.PI/2.0;
            updateShadow();
            clearLockTimer();
          },
          // hard drop
          function () {
            if (freezeInteraction) return;
            var curY;
            var traversed = 0;
            while(!isPieceInside()) {
              curY = pieceY;
              pieceY++;
              traversed++;
            }
            pieceY = curY;
            applyScore(traversed * 2); // 2 points per cell for hard drop
            dropPiece();
            clearLockTimer();
          }, 
          // timer based down
          function () {
            if (freezeInteraction) return;
            pieceY += 1; 
            if (isPieceInside()) { 
              pieceY -= 1; 
              if (lockTimer == "") {
                lockTimer = setTimeout(function(){moves[3]();},600);
              }
            }
          },
          // hold feature
          function () {
            //alert("hold unimplemented.");
          }, 
          function () {
            toggleMouseControl();
          },
          function () {
            drawIndicators = !drawIndicators;
          }
        ];
        function clearLockTimer() {
          if (lockTimer != "") {
            clearTimeout(lockTimer);
            lockTimer = "";
          }
        }
        
        var freezeInteraction = false;
        var hardDropTimeout = "";
        // sets up hard drop animation
        function dropPiece () {
          if (hardDropTimeout != "") return; 
          freezeInteraction = true;
          hardDropTimeout = setTimeout(function () {freezeInteraction = false; fixPiece(); clearLockTimer(); hardDropTimeout = "";},100);
        }
        
        // left, right
        var shiftorders = [
            [0,0], // initial
            [-1,0],[-1,1],[-1,-1],[0,-1], // col 1 block left; directly above
            [-1,2],[-1,-2], // col 1 block left, two away vertically
            [-2,0],[-2,1],[-2,-1],[-2,2],[-2,-2], // col 2 blocks left
            [0,-2], // directly above, two spaces
            
        //    [0,2], // directly below, two spaces (can cause tunnelling perhaps? one space below certainly is not needed)
        //    [-3,0],[-3,1],[-3,-1],[-3,2],[-3,-2], // col 3 blocks left -- this may be getting cheap
            [1,0],[1,1],[1,-1],[2,0],[2,1],[2,-1],[1,2],[1,-2] // move left for wall kicking
        ];
        var shiftright = 0; // 0 = left, 1 = right
            
        
        // rotation nudge. Attempts to shift piece into a space that fits nearby, if necessary.
        // if such a position is found, it will be moved there. 
        function kick() {
          var i;
          // modify this array to change the order in which shifts are tested. To favor burying pieces into gaps below,
          // place negative y offset entries closer to the front. 
         
          var oldpos = [pieceX,pieceY]; // for simplicity I reuse methods that actually modify piece position.
          for (i=0;i<shiftorders.length;i++) {
            pieceX = oldpos[0]; pieceY = oldpos[1]; // restore position
            if (shiftright) pieceX -= shiftorders[i][0];
            else pieceX += shiftorders[i][0];
            pieceY += shiftorders[i][1];
            if (!isPieceInside())
              return 0;
          }
          pieceX = oldpos[0]; pieceY = oldpos[1]; // restore position
          return 1; // return failure
        }
        
        function updatePiece() {
          var ctx = document.getElementById('animated_canvas').getContext('2d');
          drawPiece(ctx);
        }
        
        // Does not need to be called every frame like updatePiece is.
        // will be called from left and right moves, also 
        function updateShadow() {
          var ctx = document.getElementById('shadow_canvas').getContext('2d');
          drawShadow(ctx);
        }
        
        var repeatRateInitial = 200;
        var repeatRate = 100;
        var repeatIntervals = ["","","",""];
        var repeatInitPassed = [false,false,false,false];
        function setupRepeat(i) {
          if (i < 4) {
            if (repeatIntervals[i] == "") {
              repeatIntervals[i] = setTimeout(
                function () {
                  moves[i](); repeatIntervals[i] = setInterval(moves[i], repeatRate); repeatInitPassed[i] = true;
                }, repeatRateInitial
              );
            }
          }
        }
        function stopRepeat(i) {
          if (i<4 && repeatIntervals[i] != "") {
            if (repeatInitPassed[i]){
              clearInterval(repeatIntervals[i]);
            }
            else clearTimeout(repeatIntervals[i]);
            repeatIntervals[i] = "";
          }
        }
        
        var buttonList = [[37,74],[],[39,76],[40,75],[38,73,88,82],[90,84],[68,32],[],[67],[77],[78]];
        var buttonStates = new Array(buttonList.length); for (i=0;i<buttonList.length;++i) buttonStates[i] = 0;
        
        //var directionalButtonStates = [0,0,0,0]; // left up right down
        //var rotationButtonStates = [0,0] // cw, ccw
        //var dropButtonState = 0;
        //var holdButtonState = 0; 
        // these variables keep track of button state in order to customize
        // key repeat rates
        
        function keydownfunc(e) {   
          var keynum;
          if (!(e.which)) keynum = e.keyCode;
          else if (e.which) keynum = e.which;
          else return;
          var keychar = String.fromCharCode(keynum);
          //document.title = keynum;
          
          if (keychar == 'P') { 
            if (paused) unPause();
            else { setPause(false); return; }
          }
          if (paused) return;
          
          var i;
          for (i=0;i<buttonList.length;i++) {
            var j;
            for (j=0;j<buttonList[i].length;j++) {
              if (keynum == buttonList[i][j] && !buttonStates[i]){
                moves[i]();
                stopRepeat(i); // this is insurance
                setupRepeat(i);
                buttonStates[i] = 1;
              }
            }
          }
        
          //document.getElementById('msg').innerHTML = "last key pressed: "+ keynum + "inside:"+isPieceInside();
          updatePiece();
        }
        
        function keyupfunc(e) {
          var keynum;
          if (!(e.which)) keynum = e.keyCode;
          else if (e.which) keynum = e.which;
          else return;
          var keychar = String.fromCharCode(keynum);
          if (paused) return;
          
          var i;
          for (i=0;i<buttonList.length;i++) {
            var j;
            for (j=0;j<buttonList[i].length;j++) {
              if (keynum == buttonList[i][j]) {
                buttonStates[i] = 0;
                stopRepeat(i);
              }
            }
          }
          
        }
        
        var animPositionX=3;
        var animPositionY=0;
        var animRotation=0;
        
        /*
        function drawPieceOld(context) {
          var i,j;
          var tetk = tetrominos[curPiece][curRotation];
          for (j=0;j<tetk.length;j++) {
            var tetkj = tetk[j];
            for (i=0;i<tetkj.length;i++) {
              var tetkji = tetkj[i];
              if (tetkji) {
                context.save();
                context.rotate(10.0*3.1415926/180.0);
                drawBox2(animPositionX+i,animPositionY+j,tetkji,context);
                context.restore();
              }
            }
          }
        }
        */
        var drawIndicators = false;
        function drawPiece(context) {
          var i,j;
          // drawing using geometry of current rotation 
          var tetk = tetrominos[curPiece][curRotation];
          // translating (canvas origin) to the center, 
          // rotating there, then drawing the boxes
          context.clearRect(0,0,xoff*2 + xsize*10 + gapsize*9,yoff*2+ysize*24+gapsize*23);  
          if (isMouseControl && drawIndicators) {
            context.save();
            context.translate(xoff + (xsize+gapsize) * (mouseControlX+1.5),yoff);
            
            context.fillStyle = "rgba(0,0,255,"+(Math.abs((mouseControlX) - Math.floor(mouseControlX+0.5)) * 0.2 + 0.2)+")";
            context.fillRect(-xsize/4,0,xsize/2,ysize*24 + gapsize*23);
            context.restore();
          }
          context.save();
          context.fillStyle = colors[curPiece+1];
          var centerX = tet_center_rot[curPiece][0]*(xsize+gapsize)+xsize/2+(!tet_center_rot[curPiece][2])*(xsize/2+gapsize);
          var centerY = tet_center_rot[curPiece][1]*(ysize+gapsize)+ysize/2+(!tet_center_rot[curPiece][2])*(ysize/2+gapsize);
          
          context.translate(xoff + animPositionX*(xsize+gapsize) + centerX,yoff + animPositionY*(ysize+gapsize) + centerY);
          context.rotate(animRotation);
          context.translate(-centerX,-centerY); 
          
          // now in rotated coordinates, zeroed at piece origin
          for (j=0;j<tetk.length;j++) {
            var tetkj = tetk[j];
            for (i=0;i<tetkj.length;i++) {
              var tetkji = tetkj[i];
              if (tetkji) {
                context.fillRect(i*(xsize+gapsize),j*(ysize+gapsize),xsize,ysize);
              }
            }
          }
          context.restore();
          if (isMouseControl && drawIndicators) {
              context.save();
              context.translate(xoff+(animPositionX+1.5)*(xsize+gapsize),yoff);
              context.fillStyle = "rgba(255,0,0,0.3)";
              context.fillRect(-xsize/4,0,xsize/2,ysize*24+gapsize*23);
              context.restore();
          }
          
        }
        
        var shadowY = 0;
        function drawShadow(context) { 
          var curY;
          var count = 0;
          var origY = pieceY;
          while(!isPieceInside()) {
            curY = pieceY;
            pieceY++;
            count++;
          } // This is a little bad --
          // I am modifying critical program state
          // when it is not necessary.
          // This is done to increase code reuse
          pieceY = origY; 
          shadowY = curY;
          if (!count) return;
          drawShadowPieceAt(context,pieceX,curY);
        }
        
        function drawShadowPieceAt(context, gridX, gridY) {
          tetk = tetrominos[curPiece][curRotation];
          context.clearRect(0,0,xoff*2 + xsize*10 + gapsize*9,yoff*2+ysize*24+gapsize*23);  
          context.save();
          context.fillStyle = "#777";
          context.translate(xoff+gridX*(xsize+gapsize),yoff+gridY*(ysize+gapsize));
          for (j=0;j<tetk.length;j++) {
            var tetkj = tetk[j];
            for (i=0;i<tetkj.length;i++) {
              var tetkji = tetkj[i];
              if (tetkji) {
                context.fillRect(i*(xsize+gapsize),j*(ysize+gapsize),xsize,ysize);
              }
            }
          }
          context.restore();
        }
        
        var posx=0;
        var posy=0;
        function mousemovefunc(e) {
            if (!e) var e = window.event;
            if (e.pageX || e.pageY)     {
                posx = e.pageX;
                posy = e.pageY;
            }
            else if (e.clientX || e.clientY)     {
                posx = e.clientX + document.body.scrollLeft
                    + document.documentElement.scrollLeft;
                posy = e.clientY + document.body.scrollTop
                    + document.documentElement.scrollTop;
            }
          /*if (!e) e = event;
          if (e.pageX || e.pageY) {
            posx = e.pageX;
            posy = e.pageY;
          }
          else if (e.clientX || e.clientY) {
            posx = e.clientX + document.body.scrollLeft
              + document.documentElement.scrollLeft;
            posy = e.clientY + document.body.scrollTop
              + document.documentElement.scrollTop;
          } */
        
          //if (!(Math.floor((posx/5-100-(xsize+gapsize)*pieceX)/(xsize+gapsize)) <= 0)) moves[2]();
          //if (Math.floor((posx/5-100-(xsize+gapsize)*pieceX)/(xsize+gapsize))< 0) moves[0]();
          //updatePiece();
          if (!paused)
            mouseControlFunc();
        }
        
        var pausedBecauseLostFocus = false;
        function losefocusfunc() {
          if (paused) return;
          setPause(false);
          pausedBecauseLostFocus = true;
        }
        function gainfocusfunc() {
          if (paused && pausedBecauseLostFocus) {
            unPause();
          }
        }
        function mousedownfunc(e) { 
          if (isMouseControl) {
          if (e.which == 1) {
            moves[4]();
          }
          else if (e.which == 3) {
            moves[6]();
          }
          }
        }
        var score = 0;
        var level = 1;
        var isScoreIncreasing = true;
        
        var scoreCallback = function (val) {}; // I get called when score changes. 
        
        function updateLevel() {
            // Level increases every 1000 points
            var newLevel = Math.floor(score / 1000) + 1;
            if (newLevel > level) {
                level = newLevel;
                document.getElementById('level').innerHTML = "Level: " + level;
            }
        }
        
        function animateScoreAddition(points) {
            var scoreEl = document.getElementById('score-value');
            var rect = scoreEl.getBoundingClientRect();
            var animEl = document.createElement('div');
            animEl.className = 'score-animation';
            animEl.innerHTML = '+' + points;
            animEl.style.left = (rect.left + 50) + 'px';
            animEl.style.top = (rect.top - 10) + 'px';
            document.body.appendChild(animEl);
            
            setTimeout(function() {
                animEl.style.top = (rect.top - 60) + 'px';
                animEl.style.opacity = '0';
            }, 10);
            
            setTimeout(function() {
                document.body.removeChild(animEl);
            }, 1000);
        }
        
        function applyScore(amount) {
            if (isScoreIncreasing) {
                increaseScore(amount);
            } else {
                subtractScore(amount);
            }
            scoreCallback(score);
        }
        function increaseScore(amount) {
            score += amount;
            document.getElementById('score-value').innerHTML = score;
            if (amount > 0) {
                animateScoreAddition(amount);
            }
        }
        function subtractScore(amount) {
            score -= amount; 
            if (score <= 0) { // reached zero 
                gameWin();
                score = 0;
            }
          document.getElementById('score-value').innerHTML = score;
        }
        
        document.onkeydown = function (e) { keydownfunc(e); };
        document.onkeyup = function (e) { keyupfunc(e); };
        document.onmousemove = function (e) { mousemovefunc(e); };
        window.onblur = function () {losefocusfunc(); };
        window.onfocus = function () {gainfocusfunc(); };
        document.onmousedown = function (e) {mousedownfunc(e); };
        
        // for iOS preventing default scroll
        document.ontouchmove = function (e) { doc_otm(e); };
        
        function doc_otm(e) {
        
            drawTouches(); // presumably some fingers need to be updated
            if (control_finger_id != -1) { // control finger active
                for (var i=0;i<e.changedTouches.length;++i) { // search moved fingers for control finger
                    if (e.changedTouches[i].identifier == control_finger_id) { // found it
                        // verify a past position exists (it should) 
                        if (control_location[0] < 0 || control_location[1] < 0) {
                            alert("control_location not set!");
                        }
                        Control([e.changedTouches[i].clientX,e.changedTouches[i].clientY]);
                    }
                    
                }
            }
            e.preventDefault();
        
        };
        
        var touchlist = [];
        
        var lastTouchID = -1; // used for tracking potential taps 
        var lastTouchStartTime = 0;
        
        document.ontouchstart = function (e) { doc_ots(e); };
        
        function doc_ots(e) {
            touchlist = (e.touches);
        //    for (var i =0;i<touchlist.length;++i) { 
        //        console.log(i+": "+touchlist[i].identifier+" at "+touchlist[i].clientX+","+touchlist[i].clientY);
        //    }
        
            if (e.touches.length == 1) { // set this finger as control
                control_finger_id = e.touches[0].identifier;
                // initialize control_location 
                control_location = [e.touches[0].clientX,e.touches[0].clientY];
                // initialize control_accum
                control_accum = [0,0];
            }

            if (e.changedTouches.length == 1) {
                lastTouchID = e.changedTouches[0].identifier;
                lastTouchStartTime = new Date().getTime();
            }

            drawTouches();

        };

        var control_finger_id = -1;
        var control_location = [-1,-1]; // last location: -1 indicates undefined

        document.ontouchend = function (e) { doc_ote(e); }; 
        function doc_ote(e) {
            touchlist = e.touches;
            for (var i = 0; i < e.changedTouches.length; i++) { 
                if (e.changedTouches[i].identifier == control_finger_id) {
                    // Easy way out: defer control to first of remaining fingers
                    if (e.touches.length > 0) { 
                        control_finger_id = e.touches[0].identifier; 
                        control_location = [e.touches[0].clientX,e.touches[0].clientY]; 
                    } else { 
                        control_finger_id = -1; control_location = control_accum = [-1,-1]; 
                    }
                    //break;
                    //entry point for hard drop 
                       hardDropTest(e.changedTouches[i].clientX,e.changedTouches[i].clientY);    
                }
                if (!paused && e.changedTouches[i].identifier == lastTouchID && new Date().getTime() - lastTouchStartTime < 300) {
                    moves[4]();
                }
            }
            drawTouches();
        };


        // document.ontouchend  document.ontouch

        function flatten(obj, levels) {
            if (levels == 0) return '';
            var empty = true;
            if (obj instanceof Array) {
                str = '[';
                empty = true;
                for (var i=0;i<obj.length;i++) {
                    empty = false;
                    str += flatten(obj[i],levels-1)+', ';
                }
                return (empty?str:str.slice(0,-2))+']';
            } else if (obj instanceof Object) {
                str = '{'; 
                empty = true;
                for (i in obj) { 
                    empty = false;
                    str += i+'->'+flatten(obj[i],levels-1)+', '; 
                } 
                return (empty?str:str.slice(0,-2))+'}';
            } else {
                return obj; // not an obj, don't stringify me
            }
        }

        window.onselectstart = function(e) { return false; }
        // no IE
        window.onresize = function () { win_onresize(); };

        function win_onresize() {
          updateSizing();
        };

        // HERE IS THE API
        
        this.isPaused = function () { return isPaused(); }; 
        this.setPause = function () { setPause(false); };
        this.unPause = function () { unPause(); }; 
        this.setTouchSensitivity = function (value) {
            yMoveThreshold = xMoveThreshold = 30.0/value;
        }
        // returns touch_draw setting
        this.toggle_touch_draw = function () { actually_draw_touches = !actually_draw_touches;   return actually_draw_touches; }; 
        this.setScoreIncreasing = function () { isScoreIncreasing = true; score = 0; };
        this.scoreChangeCallback = function (cb) { scoreCallback = cb; };

        }; // end TETRIS namespace (this module system is some weirdness I don't yet fully understand but it works and that's all that matters)

        // Initialize the game
        TETRIS.setScoreIncreasing();
    </script>
</body>
</html>